<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Indicator Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 10px;
            background-color: #f5f5f5;
        }
        .calculator {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
        }
        .indicator-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .year-inputs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        .year-input {
            display: flex;
            flex-direction: column;
        }
        .year-input label {
            font-size: 0.9em;
            margin-bottom: 4px;
            color: #555;
        }
        input {
            padding: 6px;
            margin: 2px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #result {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .formula {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .formula-control {
            margin-bottom: 20px;
        }
        .formula-control input {
            width: 100%;
            padding: 8px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <h1>Dynamic Indicator Calculator</h1>
        <div class="formula-control">
            <input type="text" id="formulaInput" value="A + 1/(1*B + 0.5*C + 1*Y)" placeholder="Enter formula (e.g., A/(1*B + 0.5*C)">
        </div>
        <div class="formula" id="formulaContainer"></div>
        <div id="indicatorGroupsContainer"></div>
        <div id="result"></div>
    </div>
    <script>
        let currentVariables = new Set();
        let formulaStructure = { numerator: null, denominator: [] };
        function parseFormula(formula) {
            const parts = formula.split('/');
            if (parts.length !== 2) return null;
            const numerator = parts[0].trim();
            const denominatorTerms = parts[1].split('+').map(term => {
                const cleaned = term.trim().replace(/[()]/g, '');
                const [coeff, ...vars] = cleaned.split('*').map(p => p.trim());
                const coefficient = parseFloat(coeff) || 1;
                const variable = vars.join('*') || coeff;
                return { coefficient, variable };
            });
            return { numerator, denominator: denominatorTerms };
        }
        function updateInterface() {
            const formulaValue = document.getElementById('formulaInput').value;
            const parsed = parseFormula(formulaValue);
            if (!parsed || !parsed.numerator || parsed.denominator.length === 0) {
                alert('Invalid formula format! Use format: Numerator/(Coefficient*Variable + ...)');
                return;
            }
            formulaStructure = parsed;
            currentVariables = new Set([
                parsed.numerator,
                ...parsed.denominator.map(t => t.variable)
            ]);
            updateFormulaDisplay();
            createInputGroups();
            setupCalculation();
            calculate();
        }
        function updateFormulaDisplay() {
            const numerator = `\\class{highlight-${formulaStructure.numerator}}{${formulaStructure.numerator}}`;
            const denominator = formulaStructure.denominator.map(term => {
                const coeff = term.coefficient !== 1 ? `\\class{highlight-constant}{${term.coefficient}} \\cdot ` : '';
                return `${coeff}\\class{highlight-${term.variable}}{${term.variable}}`;
            }).join(' + ');
            document.getElementById('formulaContainer').innerHTML = 
                `\\[I = \\frac{${numerator}}{${denominator}}\\]`;
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, "formulaContainer"]);
        }
        function createInputGroups() {
            const container = document.getElementById('indicatorGroupsContainer');
            container.innerHTML = '';
            currentVariables.forEach(variable => {
                const group = document.createElement('div');
                group.className = 'indicator-group';
                group.innerHTML = `
                    <h3>${variable}</h3>
                    <div class="year-inputs">
                        ${[2020, 2021, 2022, 2023, 2024].map(year => `
                            <div class="year-input">
                                <label>${year}</label>
                                <input type="number" data-variable="${variable}" step="0.1">
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(group);
            });
        }
        function setupCalculation() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>Результат:</h3>
                <p>Середнє ${formulaStructure.numerator}: <span id="numAvg">0.00</span></p>
                ${formulaStructure.denominator.map(term => `
                    <p>Середнє ${term.variable}: <span id="${term.variable}Avg">0.00</span></p>
                `).join('')}
                <p><b>Результат: <span id="finalResult">0.0000</span></b></p>
            `;
        }

        function calculate() {
            const values = {};
            document.querySelectorAll('[data-variable]').forEach(input => {
                const varName = input.dataset.variable;
                values[varName] = values[varName] || [];
                values[varName].push(parseFloat(input.value) || 0);
            });
            const averages = {};
            Object.entries(values).forEach(([varName, vals]) => {
                averages[varName] = vals.reduce((a, b) => a + b, 0) / vals.length;
            });
            const numerator = averages[formulaStructure.numerator] || 0;
            let denominator = 0;
            
            formulaStructure.denominator.forEach(term => {
                const avg = averages[term.variable] || 0;
                denominator += avg * term.coefficient;
            });
            document.getElementById('numAvg').textContent = numerator.toFixed(2);
            formulaStructure.denominator.forEach(term => {
                document.getElementById(`${term.variable}Avg`).textContent = 
                    (averages[term.variable] || 0).toFixed(2);
            });
            
            const result = denominator !== 0 ? (numerator / denominator).toFixed(4) : 'N/A';
            document.getElementById('finalResult').textContent = result;
            currentVariables.forEach(varName => {
                const filled = values[varName].every(v => v !== 0);
                document.querySelectorAll(`.highlight-${varName}`).forEach(el => {
                    el.style.color = filled ? '#000' : '#888';
                });
            });
        }
        document.getElementById('formulaInput').addEventListener('input', updateInterface);
        document.getElementById('indicatorGroupsContainer').addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT') calculate();
        });
        updateInterface();
    </script>
</body>
</html>
